@page "/counter"
@using FluentSignals.Contracts
@using FluentSignals.Implementations.Core
@using FluentSignals.ServerTest.Components
@using FluentSignals.Blazor.Components
@inherits SignalComponentBase
@rendermode InteractiveServer

<PageTitle>Form Binding - FluentSignals</PageTitle>

<div class="demo-page">
    <div class="page-header">
        <h1>Form Binding with Signals</h1>
        <p class="lead">Bind form inputs to reactive signals for automatic UI updates</p>
    </div>

    <DemoSection Title="Two-Way Form Binding"
                 Description="Signals automatically sync with form inputs and update all bound UI elements"
                 CSharpCode="@formBindingCode"
                 RazorCode="@formBindingRazorCode">
        <Demo>
            <div class="form-demo">
                <div class="form-section">
                    <h4>User Profile Form</h4>
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" class="form-control" @bind="userName.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" class="form-control" @bind="userEmail.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Age:</label>
                        <input type="number" class="form-control" @bind="userAge.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" @bind="newsletter.Value" />
                            Subscribe to newsletter
                        </label>
                    </div>
                </div>

                <div class="preview-section">
                    <h4>Live Preview</h4>
                    <div class="preview-card">
                        <div class="preview-item">
                            <strong>Name:</strong> @userName.Value
                        </div>
                        <div class="preview-item">
                            <strong>Email:</strong> @userEmail.Value
                        </div>
                        <div class="preview-item">
                            <strong>Age:</strong> @userAge.Value
                        </div>
                        <div class="preview-item">
                            <strong>Newsletter:</strong> @(newsletter.Value ? "Subscribed" : "Not Subscribed")
                        </div>
                    </div>
                </div>
            </div>
        </Demo>
    </DemoSection>

    <DemoSection Title="Computed Form Values"
                 Description="Use signals to create reactive computed values from form inputs"
                 CSharpCode="@computedFormCode"
                 RazorCode="@computedFormRazorCode">
        <Demo>
            <div class="form-demo">
                <div class="form-section">
                    <h4>Shopping Calculator</h4>
                    <div class="form-group">
                        <label>Price per item:</label>
                        <input type="number" class="form-control" step="0.01" @bind="pricePerItem.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" @bind="quantity.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Tax Rate (%):</label>
                        <input type="number" class="form-control" step="0.1" @bind="taxRate.Value" @bind:event="oninput" />
                    </div>
                    <div class="form-group">
                        <label>Discount (%):</label>
                        <input type="number" class="form-control" step="0.1" @bind="discountRate.Value" @bind:event="oninput" />
                    </div>
                </div>

                <div class="calculation-results">
                    <h4>Calculation Results</h4>
                    <div class="result-grid">
                        <div class="result-item">
                            <span class="label">Subtotal:</span>
                            <span class="value">${subtotal.Value:F2}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">Discount:</span>
                            <span class="value">-${discountAmount.Value:F2}</span>
                        </div>
                        <div class="result-item">
                            <span class="label">Tax:</span>
                            <span class="value">+${taxAmount.Value:F2}</span>
                        </div>
                        <div class="result-item total">
                            <span class="label">Total:</span>
                            <span class="value">${total.Value:F2}</span>
                        </div>
                    </div>
                </div>
            </div>
        </Demo>
    </DemoSection>

    <DemoSection Title="Form Validation with Signals"
                 Description="Implement reactive form validation using signal subscriptions"
                 CSharpCode="@formValidationCode"
                 RazorCode="@formValidationRazorCode">
        <Demo>
            <div class="form-demo">
                <div class="form-section">
                    <h4>Registration Form</h4>
                    <div class="form-group">
                        <label>Username:</label>
                        <input type="text" class="form-control @(usernameError.Value ? "error" : "")" 
                               @bind="username.Value" @bind:event="oninput" />
                        @if (usernameError.Value)
                        {
                            <span class="error-message">Username must be at least 3 characters</span>
                        }
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" class="form-control @(passwordError.Value ? "error" : "")" 
                               @bind="password.Value" @bind:event="oninput" />
                        @if (passwordError.Value)
                        {
                            <span class="error-message">Password must be at least 8 characters</span>
                        }
                    </div>
                    <div class="form-group">
                        <label>Confirm Password:</label>
                        <input type="password" class="form-control @(confirmPasswordError.Value ? "error" : "")" 
                               @bind="confirmPassword.Value" @bind:event="oninput" />
                        @if (confirmPasswordError.Value)
                        {
                            <span class="error-message">Passwords do not match</span>
                        }
                    </div>
                    <button class="btn btn-primary" disabled="@(!isFormValid.Value)" @onclick="SubmitForm">
                        Register
                    </button>
                </div>

                <div class="validation-status">
                    <h4>Validation Status</h4>
                    <div class="status-list">
                        <div class="status-item @(usernameError.Value ? "invalid" : "valid")">
                            @(usernameError.Value ? "❌" : "✅") Username
                        </div>
                        <div class="status-item @(passwordError.Value ? "invalid" : "valid")">
                            @(passwordError.Value ? "❌" : "✅") Password
                        </div>
                        <div class="status-item @(confirmPasswordError.Value ? "invalid" : "valid")">
                            @(confirmPasswordError.Value ? "❌" : "✅") Password Match
                        </div>
                    </div>
                    @if (formSubmitted)
                    {
                        <div class="success-message">
                            Form submitted successfully!
                        </div>
                    }
                </div>
            </div>
        </Demo>
    </DemoSection>
</div>

@code {
    // Two-way binding demo
    private TypedSignal<string> userName = new("John Doe");
    private TypedSignal<string> userEmail = new("john@example.com");
    private TypedSignal<int> userAge = new(25);
    private TypedSignal<bool> newsletter = new(true);

    // Computed form values demo
    private TypedSignal<decimal> pricePerItem = new(10.00m);
    private TypedSignal<int> quantity = new(2);
    private TypedSignal<decimal> taxRate = new(8.5m);
    private TypedSignal<decimal> discountRate = new(10m);
    private TypedSignal<decimal> subtotal = new(0);
    private TypedSignal<decimal> discountAmount = new(0);
    private TypedSignal<decimal> taxAmount = new(0);
    private TypedSignal<decimal> total = new(0);

    // Form validation demo
    private TypedSignal<string> username = new("");
    private TypedSignal<string> password = new("");
    private TypedSignal<string> confirmPassword = new("");
    private TypedSignal<bool> usernameError = new(true);
    private TypedSignal<bool> passwordError = new(true);
    private TypedSignal<bool> confirmPasswordError = new(true);
    private TypedSignal<bool> isFormValid = new(false);
    private bool formSubmitted = false;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        // Setup computed values
        SetupComputedValues();

        // Setup form validation
        SetupFormValidation();

        // Subscribe to all signals for UI updates
        SubscribeAllSignals();
    }

    private void SetupComputedValues()
    {
        Action updateCalculations = () =>
        {
            subtotal.Value = pricePerItem.Value * quantity.Value;
            discountAmount.Value = subtotal.Value * (discountRate.Value / 100);
            var afterDiscount = subtotal.Value - discountAmount.Value;
            taxAmount.Value = afterDiscount * (taxRate.Value / 100);
            total.Value = afterDiscount + taxAmount.Value;
        };

        // Use base class subscription methods - no need for manual StateHasChanged
        SubscribeToSignalWithoutUpdate(pricePerItem, _ => updateCalculations());
        SubscribeToSignalWithoutUpdate(quantity, _ => updateCalculations());
        SubscribeToSignalWithoutUpdate(taxRate, _ => updateCalculations());
        SubscribeToSignalWithoutUpdate(discountRate, _ => updateCalculations());

        // Initial calculation
        updateCalculations();
    }

    private void SetupFormValidation()
    {
        // Username validation - use WithoutUpdate since we update other signals that trigger UI updates
        SubscribeToSignalWithoutUpdate(username, value =>
        {
            usernameError.Value = value.Length < 3;
            CheckFormValidity();
        });

        // Password validation
        SubscribeToSignalWithoutUpdate(password, value =>
        {
            passwordError.Value = value.Length < 8;
            CheckPasswordMatch();
            CheckFormValidity();
        });

        // Confirm password validation
        SubscribeToSignalWithoutUpdate(confirmPassword, value =>
        {
            CheckPasswordMatch();
            CheckFormValidity();
        });
    }

    private void CheckPasswordMatch()
    {
        confirmPasswordError.Value = password.Value != confirmPassword.Value || string.IsNullOrEmpty(confirmPassword.Value);
    }

    private void CheckFormValidity()
    {
        isFormValid.Value = !usernameError.Value && !passwordError.Value && !confirmPasswordError.Value;
    }

    private void SubscribeAllSignals()
    {
        // Subscribe all signals to trigger UI updates using the base class method
        SubscribeForUpdate(
            userName, userEmail, userAge, newsletter,
            pricePerItem, quantity, taxRate, discountRate,
            subtotal, discountAmount, taxAmount, total,
            username, password, confirmPassword,
            usernameError, passwordError, confirmPasswordError, isFormValid
        );
    }

    private void SubmitForm()
    {
        if (isFormValid.Value)
        {
            formSubmitted = true;
            // In a real app, you would submit the form data here
        }
    }

    // Code examples
    private string formBindingCode = @"using FluentSignals.Implementations.Core;

public partial class FormBindingDemo
{
    // Create signals for form fields
    private TypedSignal<string> userName = new(""John Doe"");
    private TypedSignal<string> userEmail = new(""john@example.com"");
    private TypedSignal<int> userAge = new(25);
    private TypedSignal<bool> newsletter = new(true);

    protected override void OnInitialized()
    {
        // Subscribe to changes for logging or side effects
        userName.Subscribe(name => 
            Console.WriteLine($""Name changed to: {name}""));
            
        userEmail.Subscribe(email => 
            Console.WriteLine($""Email changed to: {email}""));
    }
}";

    private string formBindingRazorCode = @"<!-- Two-way binding with signals -->
<div class=""form-group"">
    <label>Name:</label>
    <input type=""text"" @bind=""userName.Value"" @bind:event=""oninput"" />
</div>

<div class=""form-group"">
    <label>Email:</label>
    <input type=""email"" @bind=""userEmail.Value"" @bind:event=""oninput"" />
</div>

<div class=""form-group"">
    <label>Age:</label>
    <input type=""number"" @bind=""userAge.Value"" @bind:event=""oninput"" />
</div>

<div class=""form-group"">
    <label>
        <input type=""checkbox"" @bind=""newsletter.Value"" />
        Subscribe to newsletter
    </label>
</div>

<!-- Live preview updates automatically -->
<div class=""preview"">
    <p>Name: @userName.Value</p>
    <p>Email: @userEmail.Value</p>
    <p>Age: @userAge.Value</p>
    <p>Newsletter: @(newsletter.Value ? ""Yes"" : ""No"")</p>
</div>";

    private string computedFormCode = @"using FluentSignals.Implementations.Core;

public partial class ComputedFormDemo
{
    // Form input signals
    private TypedSignal<decimal> pricePerItem = new(10.00m);
    private TypedSignal<int> quantity = new(2);
    private TypedSignal<decimal> taxRate = new(8.5m);
    private TypedSignal<decimal> discountRate = new(10m);
    
    // Computed signals
    private TypedSignal<decimal> subtotal = new(0);
    private TypedSignal<decimal> discountAmount = new(0);
    private TypedSignal<decimal> taxAmount = new(0);
    private TypedSignal<decimal> total = new(0);

    protected override void OnInitialized()
    {
        // Setup reactive calculations
        Action updateCalculations = () =>
        {
            subtotal.Value = pricePerItem.Value * quantity.Value;
            discountAmount.Value = subtotal.Value * (discountRate.Value / 100);
            var afterDiscount = subtotal.Value - discountAmount.Value;
            taxAmount.Value = afterDiscount * (taxRate.Value / 100);
            total.Value = afterDiscount + taxAmount.Value;
        };

        // Subscribe to all inputs
        pricePerItem.Subscribe(_ => updateCalculations());
        quantity.Subscribe(_ => updateCalculations());
        taxRate.Subscribe(_ => updateCalculations());
        discountRate.Subscribe(_ => updateCalculations());
        
        // Initial calculation
        updateCalculations();
    }
}";

    private string computedFormRazorCode = @"<!-- Input fields -->
<div class=""form-group"">
    <label>Price per item:</label>
    <input type=""number"" step=""0.01"" 
           @bind=""pricePerItem.Value"" @bind:event=""oninput"" />
</div>

<div class=""form-group"">
    <label>Quantity:</label>
    <input type=""number"" 
           @bind=""quantity.Value"" @bind:event=""oninput"" />
</div>

<!-- Computed values update automatically -->
<div class=""results"">
    <div>Subtotal: $@subtotal.Value</div>
    <div>Discount: -$@discountAmount.Value</div>
    <div>Tax: +$@taxAmount.Value</div>
    <div class=""total"">Total: $@total.Value</div>
</div>";

    private string formValidationCode = @"using FluentSignals.Implementations.Core;

public partial class FormValidationDemo
{
    // Form fields
    private TypedSignal<string> username = new("""");
    private TypedSignal<string> password = new("""");
    private TypedSignal<string> confirmPassword = new("""");
    
    // Validation states
    private TypedSignal<bool> usernameError = new(true);
    private TypedSignal<bool> passwordError = new(true);
    private TypedSignal<bool> confirmPasswordError = new(true);
    private TypedSignal<bool> isFormValid = new(false);

    protected override void OnInitialized()
    {
        // Username validation
        username.Subscribe(value =>
        {
            usernameError.Value = value.Length < 3;
            UpdateFormValidity();
        });

        // Password validation
        password.Subscribe(value =>
        {
            passwordError.Value = value.Length < 8;
            CheckPasswordMatch();
            UpdateFormValidity();
        });

        // Confirm password validation
        confirmPassword.Subscribe(_ =>
        {
            CheckPasswordMatch();
            UpdateFormValidity();
        });
    }

    private void CheckPasswordMatch()
    {
        confirmPasswordError.Value = 
            password.Value != confirmPassword.Value || 
            string.IsNullOrEmpty(confirmPassword.Value);
    }

    private void UpdateFormValidity()
    {
        isFormValid.Value = 
            !usernameError.Value && 
            !passwordError.Value && 
            !confirmPasswordError.Value;
    }
}";

    private string formValidationRazorCode = @"<!-- Form with validation -->
<div class=""form-group"">
    <label>Username:</label>
    <input type=""text"" 
           class=""@(usernameError.Value ? ""error"" : """")"" 
           @bind=""username.Value"" @bind:event=""oninput"" />
    @if (usernameError.Value)
    {
        <span class=""error-message"">
            Username must be at least 3 characters
        </span>
    }
</div>

<!-- Submit button enabled by validation -->
<button class=""btn btn-primary"" 
        disabled=""@(!isFormValid.Value)"" 
        @onclick=""SubmitForm"">
    Register
</button>

<!-- Validation status -->
<div class=""validation-status"">
    <div class=""@(usernameError.Value ? ""invalid"" : ""valid"")"">
        @(usernameError.Value ? ""❌"" : ""✅"") Username
    </div>
    <!-- More validation items... -->
</div>";
}

<style>
    .demo-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .form-demo {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    @@media (max-width: 768px) {
        .form-demo {
            grid-template-columns: 1fr;
        }
    }

    .form-section, .preview-section, .calculation-results, .validation-status {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }

    .form-control.error {
        border-color: #dc2626;
    }

    .error-message {
        color: #dc2626;
        font-size: 0.875rem;
        margin-top: 0.25rem;
        display: block;
    }

    .preview-card {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 6px;
    }

    .preview-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
    }

    .preview-item:last-child {
        border-bottom: none;
    }

    .result-grid {
        display: grid;
        gap: 1rem;
    }

    .result-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8fafc;
        border-radius: 6px;
    }

    .result-item.total {
        background: #667eea;
        color: white;
        font-weight: 600;
        font-size: 1.25rem;
    }

    .status-list {
        display: grid;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .status-item {
        padding: 0.5rem;
        border-radius: 6px;
        font-weight: 500;
    }

    .status-item.valid {
        background: #f0fdf4;
        color: #16a34a;
    }

    .status-item.invalid {
        background: #fef2f2;
        color: #dc2626;
    }

    .success-message {
        margin-top: 1rem;
        padding: 1rem;
        background: #f0fdf4;
        color: #16a34a;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
    }

    .btn[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
    }
}</style>
